<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBB_a8hYu7k2Y1iBJKFdEzjq0MWSQjdmMw",
            authDomain: "resonant-e9742.firebaseapp.com",
            projectId: "resonant-e9742",
            storageBucket: "resonant-e9742.firebasestorage.app",
            messagingSenderId: "78620980319",
            appId: "1:78620980319:web:0471649176a45ffcef17ea",
            measurementId: "G-N59RDC2D1L"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updatePassword = updatePassword;
        window.reauthenticateWithCredential = reauthenticateWithCredential;
        window.EmailAuthProvider = EmailAuthProvider;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                loadUserProfile(user);
            }
        });
    </script>
    <title>Your Profile - Resonant</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .hidden {
            display: none;
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tab-active {
            background-color: #f3f4f6;
            border-bottom: 3px solid #7c3aed;
            color: #111827;
        }

        .tab-inactive {
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="border-b border-gray-200 bg-white">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold gradient-text hover:opacity-80">Resonant</a>
            <div class="flex items-center space-x-4">
                <a href="discover.html" class="text-purple-600 hover:text-purple-700 font-medium">Discover</a>
                <button onclick="signOutUser()" class="text-purple-600 hover:text-purple-700 font-medium">Sign Out</button>
            </div>
        </div>
    </nav>

    <!-- Tabs -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-6 flex">
            <button onclick="switchTab('dashboard')" class="tab-button tab-active py-4 px-6 font-medium" data-tab="dashboard">
                Dashboard
            </button>
            <button onclick="switchTab('profile')" class="tab-button tab-inactive py-4 px-6 font-medium" data-tab="profile">
                Edit Profile
            </button>
            <button onclick="switchTab('password')" class="tab-button tab-inactive py-4 px-6 font-medium" data-tab="password">
                Change Password
            </button>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <section id="dashboard-tab" class="py-12">
        <div class="max-w-4xl mx-auto px-6">
            <!-- Profile Card -->
            <div class="bg-white rounded-lg border-2 border-purple-600 p-8 mb-8">
                <div class="flex flex-col items-center mb-8">
                    <div class="relative mb-6">
                        <div class="w-32 h-32 bg-purple-200 rounded-full flex items-center justify-center overflow-hidden">
                            <img id="profilePic" src="" alt="Profile" class="w-full h-full object-cover hidden">
                            <span id="profileInitial" class="text-5xl text-purple-600">U</span>
                        </div>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 hidden" id="displayName">Your Name</h1>
                    <p class="text-gray-600 hidden mt-1" id="userStatus">Music Lover</p>
                    <p class="text-sm text-gray-500 mt-2" id="userEmailDisplay"></p>
                </div>

                <!-- Profile Fields -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                        <div>
                            <div class="text-sm text-gray-500">Display Name</div>
                            <div class="font-medium text-gray-900" id="dashName">Not set</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                        <div>
                            <div class="text-sm text-gray-500">Status</div>
                            <div class="font-medium text-gray-900" id="dashStatus">Not set</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                        <div>
                            <div class="text-sm text-gray-500">Favorite Artist</div>
                            <div class="font-medium text-gray-900" id="dashArtist">Not set</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-3">
                        <div>
                            <div class="text-sm text-gray-500">Favorite Song</div>
                            <div class="font-medium text-gray-900" id="dashSong">Not set</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-white rounded-lg p-6 shadow">
                    <div class="text-3xl font-bold gradient-text">0</div>
                    <div class="text-sm text-gray-600 mt-1">Playlists Created</div>
                </div>
                <div class="bg-white rounded-lg p-6 shadow">
                    <div class="text-3xl font-bold gradient-text">0</div>
                    <div class="text-sm text-gray-600 mt-1">Songs Rated</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Edit Profile Tab -->
    <section id="profile-tab" class="hidden py-12">
        <div class="max-w-4xl mx-auto px-6">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Edit Your Profile</h2>
                <form id="profileForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                        <input 
                            type="text" 
                            id="profileName" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <input 
                            type="text" 
                            id="profileStatus" 
                            placeholder="e.g., Music Lover" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture</label>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <img id="profilePicturePreview" src="" alt="Profile" class="w-20 h-20 rounded-full object-cover hidden">
                                <div id="profilePictureInitial" class="w-20 h-20 bg-purple-200 rounded-full flex items-center justify-center">
                                    <span class="text-2xl text-purple-600">U</span>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <div class="flex space-x-2">
                                    <label for="profilePictureUpload" class="px-4 py-2 border border-gray-300 rounded-lg cursor-pointer text-sm text-gray-700 hover:bg-gray-50">
                                        Choose Photo
                                    </label>
                                    <button type="button" onclick="openImageModal()" class="px-4 py-2 border border-purple-300 rounded-lg cursor-pointer text-sm text-purple-700 hover:bg-purple-50">
                                        Search Unsplash
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500">Upload from computer or search Unsplash</p>
                            </div>
                            <input type="file" id="profilePictureUpload" accept="image/*" class="hidden">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Favorite Artists</label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="profileArtist" 
                                placeholder="Search for artists..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            >
                            <div id="artistSearchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden z-10 mt-1"></div>
                        </div>
                        <div id="selectedArtists" class="flex flex-wrap gap-2 mt-3"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Favorite Songs</label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="profileSong" 
                                placeholder="Search for songs..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            >
                            <div id="songSearchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden z-10 mt-1"></div>
                        </div>
                        <div id="selectedSongs" class="flex flex-wrap gap-2 mt-3"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Favorite Genres</label>
                        <div id="genreBubbles" class="flex flex-wrap gap-2">
                            <!-- Genres will be populated by JavaScript -->
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Click genres to select/deselect them</p>
                    </div>
                    <button 
                        type="submit" 
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium transition-colors"
                    >
                        Save Changes
                    </button>
                </form>
                <div id="profileSuccess" class="hidden text-center mt-4">
                    <div class="text-green-600 font-medium">✓ Profile updated!</div>
                </div>
                <div id="profileError" class="hidden text-center mt-4">
                    <p class="text-red-600 text-sm"></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Change Password Tab -->
    <section id="password-tab" class="hidden py-12">
        <div class="max-w-4xl mx-auto px-6">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Change Password</h2>
                <form id="passwordForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                        <input 
                            type="password" 
                            id="currentPassword" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            required
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                        <input 
                            type="password" 
                            id="newPassword" 
                            minlength="6"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            required
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            minlength="6"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            required
                        >
                    </div>
                    <button 
                        type="submit" 
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium transition-colors"
                    >
                        Update Password
                    </button>
                </form>
                <div id="passwordSuccess" class="hidden text-center mt-4">
                    <div class="text-green-600 font-medium">✓ Password updated successfully!</div>
                </div>
                <div id="passwordError" class="hidden text-center mt-4">
                    <p class="text-red-600 text-sm"></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Image Search Modal -->
    <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-8 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Search Unsplash</h3>
                <button onclick="closeImageModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="mb-4">
                <input 
                    type="text" 
                    id="imageSearch" 
                    placeholder="Search for images (e.g., portrait, avatar)" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                >
            </div>

            <div id="imageResults" class="grid grid-cols-3 gap-4">
                <!-- Images will load here -->
            </div>

            <p id="imageLoading" class="text-center text-gray-600">Enter a search term and press Enter</p>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            // Hide all tabs
            document.getElementById('dashboard-tab').classList.add('hidden');
            document.getElementById('profile-tab').classList.add('hidden');
            document.getElementById('password-tab').classList.add('hidden');

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');

            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            event.target.classList.remove('tab-inactive');
            event.target.classList.add('tab-active');
        }

        function signOutUser() {
            window.firebaseAuth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        }

        function goToSignIn() {
            window.location.href = 'index.html';
        }

        async function loadUserProfile(user) {
            document.getElementById('userEmailDisplay').textContent = user.email;
            document.getElementById('profileInitial').textContent = user.email.charAt(0).toUpperCase();

            try {
                const docRef = window.doc(window.db, 'users', user.uid);
                const docSnap = await window.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log('Profile - User data loaded:', data);
                    
                    // Load onboarding data
                    if (data.displayName) {
                        document.getElementById('displayName').textContent = data.displayName;
                        document.getElementById('displayName').classList.remove('hidden');
                        document.getElementById('dashName').textContent = data.displayName;
                    } else {
                        document.getElementById('displayName').classList.add('hidden');
                        document.getElementById('dashName').textContent = 'Not set';
                    }
                    
                    if (data.bio) {
                        document.getElementById('userStatus').textContent = data.bio;
                        document.getElementById('userStatus').classList.remove('hidden');
                        document.getElementById('dashStatus').textContent = data.bio;
                    } else {
                        document.getElementById('userStatus').classList.add('hidden');
                        document.getElementById('dashStatus').textContent = 'No bio set';
                    }
                    
                    if (data.profilePicture) {
                        document.getElementById('profilePic').src = data.profilePicture;
                        document.getElementById('profilePic').classList.remove('hidden');
                        document.getElementById('profileInitial').classList.add('hidden');
                        
                        // Also show in edit form
                        document.getElementById('profilePicturePreview').src = data.profilePicture;
                        document.getElementById('profilePicturePreview').classList.remove('hidden');
                        document.getElementById('profilePictureInitial').classList.add('hidden');
                        profilePictureData = data.profilePicture;
                    }
                    
                    // Load favorite artists
                    if (data.favoriteArtists && data.favoriteArtists.length > 0) {
                        const artistNames = data.favoriteArtists.map(artist => artist.name).join(', ');
                        document.getElementById('dashArtist').textContent = artistNames;
                    } else {
                        document.getElementById('dashArtist').textContent = 'No artists selected';
                    }
                    
                    // Load favorite songs
                    if (data.favoriteSongs && data.favoriteSongs.length > 0) {
                        const songNames = data.favoriteSongs.map(song => `${song.name} - ${song.artist}`).join(', ');
                        document.getElementById('dashSong').textContent = songNames;
                    } else {
                        document.getElementById('dashSong').textContent = 'No songs selected';
                    }

                    // Fill edit form with existing data
                    document.getElementById('profileName').value = data.displayName || '';
                    document.getElementById('profileStatus').value = data.bio || '';
                    
                    // Load existing artists into the search selection
                    profileSelectedArtists = data.favoriteArtists || [];
                    updateSelectedArtists();
                    
                    // Load existing songs into the search selection
                    profileSelectedSongs = data.favoriteSongs || [];
                    updateSelectedSongs();
                    
                    // Load existing genres into the genre selection
                    profileSelectedGenres = data.favoriteGenres || [];
                    updateSelectedGenres();

                    console.log('Profile - All data loaded successfully');
                } else {
                    console.log('Profile - No user data found');
                }
            } catch (error) {
                console.error('Profile - Error loading user data:', error);
            }
        }

        // Save profile changes
        async function saveProfileChanges() {
            console.log('Profile - Save function called');
            const user = window.firebaseAuth.currentUser;
            if (!user) {
                console.log('Profile - No user found');
                return;
            }
            
            const name = document.getElementById('profileName').value.trim();
            const status = document.getElementById('profileStatus').value.trim();
            
            console.log('Profile - Form values:', { name, status, profilePictureData, profileSelectedArtists, profileSelectedSongs });
            
            const submitBtn = document.querySelector('#profileForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            document.getElementById('profileSuccess').classList.add('hidden');
            document.getElementById('profileError').classList.add('hidden');
            
            try {
                console.log('Profile - Starting save process');
                console.log('Profile - Form values:', { name, status });
                console.log('Profile - Selected artists:', profileSelectedArtists);
                console.log('Profile - Selected songs:', profileSelectedSongs);
                
                // Get current user data first to preserve existing arrays
                const currentDoc = await window.getDoc(window.doc(window.db, 'users', user.uid));
                const currentData = currentDoc.exists() ? currentDoc.data() : {};
                console.log('Profile - Current data:', currentData);
                
                // Prepare update data
                const updateData = {
                    email: user.email,
                    favoriteArtists: profileSelectedArtists,
                    favoriteSongs: profileSelectedSongs,
                    favoriteGenres: profileSelectedGenres
                };
                
                // Only update fields that are actually changed
                if (name) {
                    updateData.displayName = name;
                    console.log('Profile - Will update displayName:', name);
                }
                if (status) {
                    updateData.bio = status;
                    console.log('Profile - Will update bio:', status);
                }
                
                console.log('Profile - Will update artists:', profileSelectedArtists);
                console.log('Profile - Will update songs:', profileSelectedSongs);
                console.log('Profile - Will update genres:', profileSelectedGenres);
                
                // Preserve profile picture - use new upload if provided, otherwise keep existing
                if (profilePictureData) {
                    updateData.profilePicture = profilePictureData;
                    console.log('Profile - Using new profile picture, type:', typeof profilePictureData);
                    console.log('Profile - Profile picture data length:', profilePictureData.length);
                    console.log('Profile - Profile picture starts with:', profilePictureData.substring(0, 50));
                } else if (currentData.profilePicture) {
                    updateData.profilePicture = currentData.profilePicture;
                    console.log('Profile - Preserving existing profile picture');
                } else {
                    console.log('Profile - No profile picture data found');
                }
                
                // Preserve other onboarding data (but NOT favoriteGenres - use the new ones)
                if (currentData.onboardingCompleted !== undefined) {
                    updateData.onboardingCompleted = currentData.onboardingCompleted;
                }
                if (currentData.onboardingStep !== undefined) {
                    updateData.onboardingStep = currentData.onboardingStep;
                }
                
                console.log('Profile - Final update data:', updateData);
                await window.setDoc(window.doc(window.db, 'users', user.uid), updateData, { merge: true });
                console.log('Profile - Save completed successfully');
                
                // Update dashboard
                document.getElementById('dashName').textContent = name || 'Not set';
                document.getElementById('dashStatus').textContent = status || 'Not set';
                
                if (profileSelectedArtists.length > 0) {
                    const artistNames = profileSelectedArtists.map(a => a.name).join(', ');
                    document.getElementById('dashArtist').textContent = artistNames;
                } else {
                    document.getElementById('dashArtist').textContent = 'No artists selected';
                }
                
                if (profileSelectedSongs.length > 0) {
                    const songNames = profileSelectedSongs.map(s => `${s.name} - ${s.artist}`).join(', ');
                    document.getElementById('dashSong').textContent = songNames;
                } else {
                    document.getElementById('dashSong').textContent = 'No songs selected';
                }
                
                // Update dashboard profile picture if changed
                if (profilePictureData) {
                    document.getElementById('profilePic').src = profilePictureData;
                    document.getElementById('profilePic').classList.remove('hidden');
                    document.getElementById('profileInitial').classList.add('hidden');
                    console.log('Profile - Dashboard profile picture updated');
                }
                
                document.getElementById('profileSuccess').classList.remove('hidden');
                console.log('Profile - Success message shown');
            } catch (error) {
                console.error('Profile - Save error:', error);
                document.getElementById('profileError').textContent = error.message;
                document.getElementById('profileError').classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                console.log('Profile - Button reset');
            }
        };

        // Profile search functionality
        const LASTFM_API_KEY = 'ac6c830c5a1663978b4ae0376595ac62';
        const LASTFM_API_URL = 'https://ws.audioscrobbler.com/2.0/';
        
        let profileSelectedArtists = [];
        let profileSelectedSongs = [];
        
        // Search functions
        async function searchArtists(query) {
            if (!query || query.length < 2) return [];
            
            try {
                const url = `${LASTFM_API_URL}?method=artist.search&artist=${encodeURIComponent(query)}&api_key=${LASTFM_API_KEY}&format=json&limit=10`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.results && data.results.artistmatches && data.results.artistmatches.artist) {
                    return data.results.artistmatches.artist.map(artist => ({
                        name: artist.name,
                        mbid: artist.mbid || 'unknown',
                        listeners: parseInt(artist.listeners) || 0,
                        url: artist.url
                    }));
                }
                return [];
            } catch (error) {
                console.error('Error searching artists:', error);
                return [];
            }
        }
        
        async function searchSongs(query) {
            if (!query || query.length < 2) return [];
            
            try {
                const url = `${LASTFM_API_URL}?method=track.search&track=${encodeURIComponent(query)}&api_key=${LASTFM_API_KEY}&format=json&limit=10`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.results && data.results.trackmatches && data.results.trackmatches.track) {
                    return data.results.trackmatches.track.map(track => ({
                        name: track.name,
                        artist: track.artist,
                        mbid: track.mbid || 'unknown',
                        listeners: parseInt(track.listeners) || 0,
                        url: track.url
                    }));
                }
                return [];
            } catch (error) {
                console.error('Error searching songs:', error);
                return [];
            }
        }
        
        function formatListeners(count) {
            if (count >= 1000000) {
                return (count / 1000000).toFixed(1) + 'M';
            } else if (count >= 1000) {
                return (count / 1000).toFixed(1) + 'K';
            }
            return count.toString();
        }
        
        // Display search results
        function displayArtistResults(results) {
            const container = document.getElementById('artistSearchResults');
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="p-4 text-gray-500 text-center">No artists found</div>';
                container.classList.remove('hidden');
                return;
            }
            
            container.innerHTML = results.map(artist => `
                <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 artist-result-item" data-artist-name="${artist.name}" data-artist-mbid="${artist.mbid}">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium text-gray-900">${artist.name}</div>
                            <div class="text-sm text-gray-500">${formatListeners(artist.listeners)} listeners</div>
                        </div>
                        <div class="text-purple-600 text-sm font-medium">Click to Add</div>
                    </div>
                </div>
            `).join('');
            container.classList.remove('hidden');
        }
        
        function displaySongResults(results) {
            const container = document.getElementById('songSearchResults');
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="p-4 text-gray-500 text-center">No songs found</div>';
                container.classList.remove('hidden');
                return;
            }
            
            container.innerHTML = results.map(song => `
                <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 song-result-item" data-song-name="${song.name}" data-song-artist="${song.artist}" data-song-mbid="${song.mbid}">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium text-gray-900">${song.name}</div>
                            <div class="text-sm text-gray-500">${song.artist} • ${formatListeners(song.listeners)} listeners</div>
                        </div>
                        <div class="text-purple-600 text-sm font-medium">Click to Add</div>
                    </div>
                </div>
            `).join('');
            container.classList.remove('hidden');
        }
        
        // Add/remove functions
        function addArtist(name, mbid) {
            if (!profileSelectedArtists.some(artist => artist.name === name)) {
                profileSelectedArtists.push({ name, mbid });
                updateSelectedArtists();
                document.getElementById('artistSearchResults').classList.add('hidden');
                document.getElementById('profileArtist').value = '';
            }
        }
        
        function addSong(name, artist, mbid) {
            if (!profileSelectedSongs.some(song => song.name === name && song.artist === artist)) {
                profileSelectedSongs.push({ name, artist, mbid });
                updateSelectedSongs();
                document.getElementById('songSearchResults').classList.add('hidden');
                document.getElementById('profileSong').value = '';
            }
        }
        
        function removeArtist(mbid) {
            profileSelectedArtists = profileSelectedArtists.filter(a => a.mbid !== mbid);
            updateSelectedArtists();
        }
        
        function removeSong(mbid) {
            profileSelectedSongs = profileSelectedSongs.filter(s => s.mbid !== mbid);
            updateSelectedSongs();
        }
        
        function updateSelectedArtists() {
            const container = document.getElementById('selectedArtists');
            container.innerHTML = profileSelectedArtists.map(artist => `
                <div class="inline-flex items-center space-x-2 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">
                    <span>${artist.name}</span>
                    <button type="button" onclick="removeArtist('${artist.mbid}')" class="text-purple-600 hover:text-purple-800">×</button>
                </div>
            `).join('');
        }
        
        function updateSelectedSongs() {
            const container = document.getElementById('selectedSongs');
            container.innerHTML = profileSelectedSongs.map(song => `
                <div class="inline-flex items-center space-x-2 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">
                    <span>${song.name} - ${song.artist}</span>
                    <button type="button" onclick="removeSong('${song.mbid}')" class="text-purple-600 hover:text-purple-800">×</button>
                </div>
            `).join('');
        }
        
        // Search input handlers
        let artistSearchTimeout;
        document.getElementById('profileArtist').addEventListener('input', function(e) {
            clearTimeout(artistSearchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('artistSearchResults').classList.add('hidden');
                return;
            }
            
            artistSearchTimeout = setTimeout(async () => {
                const results = await searchArtists(query);
                displayArtistResults(results);
            }, 300);
        });
        
        let songSearchTimeout;
        document.getElementById('profileSong').addEventListener('input', function(e) {
            clearTimeout(songSearchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('songSearchResults').classList.add('hidden');
                return;
            }
            
            songSearchTimeout = setTimeout(async () => {
                const results = await searchSongs(query);
                displaySongResults(results);
            }, 300);
        });
        
        // Click handlers for search results
        document.addEventListener('click', function(e) {
            if (e.target.closest('.artist-result-item')) {
                const item = e.target.closest('.artist-result-item');
                const name = item.dataset.artistName;
                const mbid = item.dataset.artistMbid;
                addArtist(name, mbid);
            }
            if (e.target.closest('.song-result-item')) {
                const item = e.target.closest('.song-result-item');
                const name = item.dataset.songName;
                const artist = item.dataset.songArtist;
                const mbid = item.dataset.songMbid;
                addSong(name, artist, mbid);
            }
        });
        
        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#profileArtist') && !e.target.closest('#artistSearchResults')) {
                document.getElementById('artistSearchResults').classList.add('hidden');
            }
            if (!e.target.closest('#profileSong') && !e.target.closest('#songSearchResults')) {
                document.getElementById('songSearchResults').classList.add('hidden');
            }
        });

        // Profile picture upload functionality
        let profilePictureData = null;
        
        document.getElementById('profilePictureUpload').addEventListener('change', function(e) {
            console.log('Profile - File input changed');
            const file = e.target.files[0];
            console.log('Profile - File selected:', file);
            
            if (file && file.type.startsWith('image/')) {
                console.log('Profile - File is valid image:', file.type, file.size);
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('File size must be less than 5MB');
                    e.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePictureData = e.target.result;
                    console.log('Profile - FileReader completed, data length:', profilePictureData.length);
                    console.log('Profile - Data starts with:', profilePictureData.substring(0, 50));
                    
                    document.getElementById('profilePicturePreview').src = profilePictureData;
                    document.getElementById('profilePicturePreview').classList.remove('hidden');
                    document.getElementById('profilePictureInitial').classList.add('hidden');
                    
                    console.log('Profile - Preview updated');
                };
                reader.readAsDataURL(file);
                console.log('Profile - FileReader started');
            } else {
                console.log('Profile - Invalid file or no file selected');
            }
        });

        // Genre selection functionality
        let profileSelectedGenres = [];
        
        const allGenres = [
            'pop', 'rock', 'hip-hop', 'electronic', 'jazz', 'classical', 'country', 'r&b', 
            'indie', 'metal', 'punk', 'folk', 'blues', 'reggae', 'dance', 'alternative',
            'experimental', 'ambient', 'trap', 'drill', 'lo-fi', 'shoegaze', 'post-rock',
            'math rock', 'idm', 'drone', 'noise', 'chillwave', 'vaporwave', 'future bass'
        ];
        
        function initializeGenreBubbles() {
            const genreContainer = document.getElementById('genreBubbles');
            genreContainer.innerHTML = '';
            
            allGenres.forEach(genre => {
                const bubble = document.createElement('div');
                bubble.className = 'px-3 py-1 rounded-full border border-gray-300 cursor-pointer transition-all hover:border-purple-400 text-sm';
                bubble.textContent = genre;
                bubble.dataset.genre = genre;
                
                bubble.addEventListener('click', function() {
                    toggleGenre(genre);
                });
                
                genreContainer.appendChild(bubble);
            });
        }
        
        function toggleGenre(genre) {
            const index = profileSelectedGenres.indexOf(genre);
            const bubble = document.querySelector(`[data-genre="${genre}"]`);
            
            if (index > -1) {
                // Remove genre
                profileSelectedGenres.splice(index, 1);
                bubble.classList.remove('bg-purple-600', 'text-white', 'border-purple-600');
                bubble.classList.add('border-gray-300');
            } else {
                // Add genre
                profileSelectedGenres.push(genre);
                bubble.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
                bubble.classList.remove('border-gray-300');
            }
            
            console.log('Profile - Selected genres:', profileSelectedGenres);
        }
        
        function updateSelectedGenres() {
            // Clear all selections first
            document.querySelectorAll('#genreBubbles > div').forEach(bubble => {
                bubble.classList.remove('bg-purple-600', 'text-white', 'border-purple-600');
                bubble.classList.add('border-gray-300');
            });
            
            // Apply selections
            profileSelectedGenres.forEach(genre => {
                const bubble = document.querySelector(`[data-genre="${genre}"]`);
                if (bubble) {
                    bubble.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
                    bubble.classList.remove('border-gray-300');
                }
            });
        }
        
        // Initialize genre bubbles when page loads
        initializeGenreBubbles();

        // Profile form submit handler
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await saveProfileChanges();
        });

        // Password change functionality
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const user = window.firebaseAuth.currentUser;
            if (!user) return;
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');
            
            // Reset messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validation
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters long';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            const submitBtn = document.querySelector('#passwordForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            
            try {
                // Reauthenticate user first
                const credential = window.EmailAuthProvider.credential(user.email, currentPassword);
                await window.reauthenticateWithCredential(user, credential);
                
                // Update password
                await window.updatePassword(user, newPassword);
                
                // Clear form
                document.getElementById('passwordForm').reset();
                
                // Show success message
                successDiv.classList.remove('hidden');
                
                // Hide success message after 3 seconds
                setTimeout(() => {
                    successDiv.classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                console.error('Error updating password:', error);
                if (error.code === 'auth/wrong-password') {
                    errorDiv.textContent = 'Current password is incorrect';
                } else if (error.code === 'auth/too-many-requests') {
                    errorDiv.textContent = 'Too many failed attempts. Please try again later';
                } else {
                    errorDiv.textContent = error.message || 'Failed to update password';
                }
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Image search functionality
        document.getElementById('imageSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUnsplash(this.value);
            }
        });

        function openImageModal() {
            document.getElementById('imageModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.getElementById('imageSearch').value = '';
            document.getElementById('imageResults').innerHTML = '';
        }

        async function searchUnsplash(query) {
            if (!query.trim()) return;
            
            const resultsDiv = document.getElementById('imageResults');
            resultsDiv.innerHTML = '<p class="col-span-3 text-center text-gray-600">Searching...</p>';
            
            try {
                const response = await fetch(`https://api.unsplash.com/search/photos?query=${query}&per_page=9&client_id=GGw6chqRVe8wE486U_rghYJcBnSbI5t8ptnPFtKprlM`);
                const data = await response.json();
                
                resultsDiv.innerHTML = '';
                
                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<p class="col-span-3 text-center text-gray-600">No images found</p>';
                    return;
                }
                
                data.results.forEach(image => {
                    const img = document.createElement('img');
                    img.src = image.urls.small;
                    img.alt = image.alt_description;
                    img.className = 'w-full h-32 object-cover rounded cursor-pointer hover:opacity-80 transition-opacity';
                    img.onclick = () => selectImage(image.urls.regular);
                    resultsDiv.appendChild(img);
                });
            } catch (error) {
                console.error('Error searching Unsplash:', error);
                resultsDiv.innerHTML = '<p class="col-span-3 text-center text-red-600">Error searching images</p>';
            }
        }

        function selectImage(imageUrl) {
            try {
                // Update the profile edit form preview
                document.getElementById('profilePicturePreview').src = imageUrl;
                document.getElementById('profilePicturePreview').classList.remove('hidden');
                document.getElementById('profilePictureInitial').classList.add('hidden');
                
                // Also update the main profile display
                document.getElementById('profilePic').src = imageUrl;
                document.getElementById('profilePic').classList.remove('hidden');
                document.getElementById('profileInitial').classList.add('hidden');
                
                // Set the profile picture data for saving
                profilePictureData = imageUrl;
                
                closeImageModal();
                console.log('Profile - Unsplash image selected for profile edit');
            } catch (error) {
                console.error('Error selecting Unsplash image:', error);
                alert('Failed to select image');
            }
        }
    </script>
</body>
</html>